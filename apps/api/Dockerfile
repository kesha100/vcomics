# Use the official Node.js image as a base
FROM node:18-alpine as builder

# Set environment variables
ENV DATABASE_URL=$DATABASE_URL \
    HOME=$HOME \
    HOSTNAME=$HOSTNAME \
    NIXPACKS_BUILD_CMD=$NIXPACKS_BUILD_CMD \
    NIXPACKS_START_CMD=$NIXPACKS_START_CMD \
    OPENAI_API_KEY=$OPENAI_API_KEY \
    PATH=$PATH \
    PORT=$PORT \
    POSTGRES_DB=$POSTGRES_DB \
    POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
    POSTGRES_USER=$POSTGRES_USER \
    RAILWAY_BETA_ENABLE_RUNTIME_V2=$RAILWAY_BETA_ENABLE_RUNTIME_V2 \
    RAILWAY_ENVIRONMENT=$RAILWAY_ENVIRONMENT \
    RAILWAY_ENVIRONMENT_ID=$RAILWAY_ENVIRONMENT_ID \
    RAILWAY_ENVIRONMENT_NAME=$RAILWAY_ENVIRONMENT_NAME \
    RAILWAY_GIT_AUTHOR=$RAILWAY_GIT_AUTHOR \
    RAILWAY_GIT_BRANCH=$RAILWAY_GIT_BRANCH \
    RAILWAY_GIT_COMMIT_MESSAGE=$RAILWAY_GIT_COMMIT_MESSAGE \
    RAILWAY_GIT_COMMIT_SHA=$RAILWAY_GIT_COMMIT_SHA \
    RAILWAY_GIT_REPO_NAME=$RAILWAY_GIT_REPO_NAME \
    RAILWAY_GIT_REPO_OWNER=$RAILWAY_GIT_REPO_OWNER \
    RAILWAY_PRIVATE_DOMAIN=$RAILWAY_PRIVATE_DOMAIN \
    RAILWAY_PROJECT_ID=$RAILWAY_PROJECT_ID \
    RAILWAY_PROJECT_NAME=$RAILWAY_PROJECT_NAME \
    RAILWAY_SERVICE_ID=$RAILWAY_SERVICE_ID \
    RAILWAY_SERVICE_NAME=$RAILWAY_SERVICE_NAME \
    REPLICATE_API_TOKEN=$REPLICATE_API_TOKEN \
    SSL_CERT_DIR=$SSL_CERT_DIR \
    STABILITY_AI_API_KEY=$STABILITY_AI_API_KEY \
    SUPABASE_API_KEY=$SUPABASE_API_KEY \
    SUPABASE_API_URL=$SUPABASE_API_URL \
    UPLOADTHING_APP_ID=$UPLOADTHING_APP_ID \
    UPLOADTHING_SECRET=$UPLOADTHING_SECRET \
    USER=$USER \
    container=$container


# RUN apt-get update && apt-get install -y python3 python3-pip build-essential
RUN npm cache clean --force

# Set the working directory
WORKDIR /app

# Copy all files to the working directory
COPY package*.json ./

# Install dependencies
RUN npm install
COPY . .
# Run the build command
RUN npx @nestjs/cli build

FROM node:14-alpine
WORKDIR /app
COPY --from=builder /app .
# Expose the application port
EXPOSE 8000

# Set the command to start the application
CMD ["npm", "run", "start:dev"]
